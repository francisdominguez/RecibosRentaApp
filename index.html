<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recibo de Pago de Renta (Alquiler)</title>

    <!-- === METADATOS PWA / INSTALACIÓN === -->
    <!-- Ícono para navegadores modernos (Favicon) -->
    <link rel="icon" type="image/png" href="app-icon.png">
    <!-- Ícono para pantallas de inicio de iOS (Apple Touch Icon) -->
    <link rel="apple-touch-icon" href="app-icon.png">
    <!-- Para Android/Windows: Color de la barra de título -->
    <meta name="theme-color" content="#1A73E8"> 
    
    <!-- LÍNEA CRÍTICA: Enlace al archivo manifest que permite la instalación PWA -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Meta tag para iOS: Permite modo standalone (fullscreen) -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <!-- Incluir la librería PDFMake para generar el comprobante PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.10/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.10/vfs_fonts.js"></script>
    <style>
        /* === ESTILOS GENERALES Y MAQUETACIÓN === */
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            padding: 10px; 
            background: #f4f6f9; 
            color: #333; 
        }
        .container { 
            max-width: 900px; 
            margin: 0 auto; 
            background: #fff;
            padding: 20px; 
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        h1 { font-size: 1.5rem; margin-bottom: 5px; color: #1A73E8; }
        h2 { 
            font-size: 1.2rem;
            color: #1A73E8; 
            border-bottom: 2px solid #1A73E8; 
            padding-bottom: 8px; 
            margin-top: 25px;
        }
        
        /* === GRIDS Y FORMULARIOS (Móvil-first) === */
        .grid-2, .grid-3 {
            display: grid;
            gap: 15px;
            margin-bottom: 15px;
            grid-template-columns: 1fr; 
        }
        @media (min-width: 600px) {
            .grid-2 { grid-template-columns: 1fr 1fr; }
            .grid-3 { grid-template-columns: repeat(3, 1fr); }
            .totales.grid-2 { grid-template-columns: repeat(2, 1fr); }
        }

        .form-group { display: flex; flex-direction: column; }
        label { 
            font-size: 0.85rem; 
            font-weight: 600; 
            margin-bottom: 4px; 
            color: #555; 
        }
        input, select { 
            padding: 10px; 
            border: 1px solid #ccc; 
            border-radius: 6px; 
            font-size: 1rem; 
            box-sizing: border-box;
            background-color: #fcfcfc;
        }
        input[readonly] { 
            background-color: #eee; 
            font-weight: 700;
            color: #1A73E8;
            cursor: default;
        }

        /* === TOTALES === */
        .totales {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #ddd;
            background-color: #f7f9fc;
        }
        .total-final {
            font-size: 1.3rem; 
            font-weight: 700;
            color: #C0392B; 
            margin-top: 10px;
            padding-top: 8px;
            border-top: 2px dashed #ddd;
            text-align: right;
        }

        /* === ACCIONES Y BOTONES === */
        .actions {
            margin-top: 20px;
            text-align: center;
        }
        button {
            width: 100%; 
            padding: 12px;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            background-color: #1A73E8;
            color: #fff;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #155bb5;
        }
        @media (min-width: 600px) {
             button { width: auto; padding: 12px 25px; }
        }
        
        /* Ocultar spinners de number inputs */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        input[type=number] { 
            -moz-appearance: textfield; 
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Recibo de Pago de Renta</h1>

        <!-- SECCIÓN 1: DATOS DE LA PROPIEDAD Y PROPIETARIO -->
        <h2>Datos del Propietario/Inmueble</h2>
        <div class="form-group"><label for="propietario">Nombre del Propietario/Administrador</label><input id="propietario" value="Nombre del Dueño/Administrador" /></div>
        <div class="form-group"><label for="direccionInmueble">Dirección del Inmueble</label><input id="direccionInmueble" value="Calle Principal #10, Sector X, Ciudad Z" /></div>

        <!-- SECCIÓN 2: DATOS DEL INQUILINO -->
        <h2>Datos del Inquilino</h2>
        <div class="grid-2">
            <div class="form-group"><label for="inquilino">Nombre del Inquilino</label><input id="inquilino" value="Juan Pérez" /></div>
            <div class="form-group"><label for="cedulaInquilino">Cédula del Inquilino</label><input id="cedulaInquilino" value="001-0000000-0" /></div>
        </div>
        <div class="form-group"><label for="telefonoInquilino">Teléfono</label><input id="telefonoInquilino" value="(809) 555-1234" /></div>


        <!-- SECCIÓN 3: DETALLE DEL PAGO -->
        <h2>Detalle del Pago</h2>
        <div class="grid-3">
            <div class="form-group">
                <label for="mesRenta">Mes de Renta a Pagar</label>
                <select id="mesRenta">
                    <option value="ENERO">Enero</option>
                    <option value="FEBRERO">Febrero</option>
                    <option value="MARZO">Marzo</option>
                    <option value="ABRIL">Abril</option>
                    <option value="MAYO">Mayo</option>
                    <option value="JUNIO">Junio</option>
                    <option value="JULIO">Julio</option>
                    <option value="AGOSTO">Agosto</option>
                    <option value="SEPTIEMBRE">Septiembre</option>
                    <option value="OCTUBRE">Octubre</option>
                    <option value="NOVIEMBRE" selected>Noviembre</option>
                    <option value="DICIEMBRE">Diciembre</option>
                </select>
            </div>
            <div class="form-group"><label for="fechaPago">Fecha de Pago</label><input id="fechaPago" type="date" value=""></div>
            <div class="form-group"><label for="referencia">No. Referencia/Recibo</label><input id="referencia" value="R-2025-12-001" readonly /></div>
        </div>

        <!-- SECCIÓN 4: CÁLCULOS -->
        <div class="totales grid-2">
            <div class="form-group"><label for="montoRenta">Monto Base de Renta (RD$)</label><input id="montoRenta" type="text" class="monto num" value="15.000,00" /></div>
            <div class="form-group"><label for="mora">Moras/Intereses (RD$)</label><input id="mora" type="text" class="monto num" value="0,00" /></div>
            
            <div class="form-group"><label for="descuento">Descuento (RD$)</label><input id="descuento" type="text" class="monto num" value="0,00" /></div>
            
            <div class="form-group"><label for="totalPagar">TOTAL PAGADO (RD$)</label><input id="totalPagar" type="text" class="total-final" readonly value="15.000,00" /></div>
        </div>

        <div class="actions">
            <button id="generatePdfBtn">Generar Recibo de Pago (PDF A6)</button>
        </div>
    </div>

<script>
// --- UTILS PARA MANEJO DE MONEDA (Formato Dominicano) ---

const formatCurrency = (num) => {
    return new Intl.NumberFormat('es-DO', { 
        style: 'decimal',
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    }).format(parseFloat(num) || 0);
};

const parseCurrency = (str) => {
    if (typeof str === 'number') return str;
    if (!str) return 0;
    let cleaned = String(str).replace(/[^\d.,]/g, ''); 
    cleaned = cleaned.replace(/\./g, '');
    cleaned = cleaned.replace(/,/g, '.'); 
    return parseFloat(cleaned) || 0;
};

// --- LÓGICA DE CÁLCULO ---

function calculateTotals() {
    const montoRenta = parseCurrency(document.getElementById('montoRenta').value);
    const mora = parseCurrency(document.getElementById('mora').value);
    const descuento = parseCurrency(document.getElementById('descuento').value);
    
    const totalPagar = montoRenta + mora - descuento;
    
    document.getElementById('totalPagar').value = formatCurrency(totalPagar);
    
    saveFormData();
}

// --- LÓGICA DE REFERENCIA AUTOMÁTICA (Persistencia Local) ---

const SEQUENCE_KEY = 'rentaReciboSequence';

function getNextReference() {
    const now = new Date();
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0'); 
    
    const currentSeqKey = `${year}-${month}`;
    const sequenceData = JSON.parse(localStorage.getItem(SEQUENCE_KEY) || '{}');
    
    let lastSequence = sequenceData[currentSeqKey] || 0; 
    
    const formattedSequence = String(lastSequence + 1).padStart(3, '0');

    return `R-${currentSeqKey}-${formattedSequence}`;
}

function updateReferenceField() {
    document.getElementById('referencia').value = getNextReference();
}

function incrementSequence() {
    const now = new Date();
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const currentSeqKey = `${year}-${month}`;
    
    const sequenceData = JSON.parse(localStorage.getItem(SEQUENCE_KEY) || '{}');
    let lastSequence = sequenceData[currentSeqKey] || 0;
    
    sequenceData[currentSeqKey] = lastSequence + 1;
    localStorage.setItem(SEQUENCE_KEY, JSON.stringify(sequenceData));
    
    // Actualizar el campo en la interfaz para mostrar el siguiente número
    updateReferenceField(); 
}

// --- LÓGICA DE GUARDADO LOCALSTORAGE (Datos del Formulario) ---

const FORM_DATA_KEY = 'rentaFacturaData';

function saveFormData() {
    const data = {};
    document.querySelectorAll('input, select').forEach(element => {
        // No guardamos la Referencia ya que es generada automáticamente
        if (element.id && element.id !== 'referencia') {
            data[element.id] = element.value;
        }
    });
    localStorage.setItem(FORM_DATA_KEY, JSON.stringify(data));
}

function loadFormData() {
    const dataString = localStorage.getItem(FORM_DATA_KEY);
    if (dataString) {
        const data = JSON.parse(dataString);
        document.querySelectorAll('input, select').forEach(element => {
            if (element.id && data[element.id] !== undefined) {
                element.value = data[element.id];
            }
        });
        calculateTotals();
    } else {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('fechaPago').value = today;
        calculateTotals();
    }
}

function attachInputListeners() {
    document.querySelectorAll('input, select').forEach(element => {
        element.addEventListener('change', saveFormData);
        if (element.type === 'text' || element.type === 'number' || element.type === 'date') {
             element.addEventListener('input', saveFormData);
        }
    });
    
    document.querySelectorAll('.monto').forEach(input => {
        input.addEventListener('blur', (e) => {
            const rawValue = parseCurrency(e.target.value);
            e.target.value = formatCurrency(rawValue);
            saveFormData();
        });
        input.addEventListener('input', calculateTotals); 
    });
}


// --- LÓGICA DE PDF MAKE (Tiquete A6) ---

function buildPdfDefinition() {
    const v = id => document.getElementById(id).value.trim();

    // Valores capturados
    const propietario = v('propietario');
    const direccionInmueble = v('direccionInmueble');
    const inquilino = v('inquilino');
    const cedulaInquilino = v('cedulaInquilino');
    const telefonoInquilino = v('telefonoInquilino');
    const mesRenta = v('mesRenta');
    const fechaPago = v('fechaPago');
    const referencia = v('referencia');
    const montoRenta = v('montoRenta');
    const mora = v('mora');
    const descuento = v('descuento');
    const totalPagar = v('totalPagar');
    
    // Configuración de Colores
    const PRIMARY_COLOR = '#1A73E8';
    const SECONDARY_COLOR = '#0C3D77';

    // Para control opcional de líneas en el PDF
    const moraRaw = parseCurrency(mora);
    const descuentoRaw = parseCurrency(descuento);
    
    const tableBody = [
        [{ text: 'CONCEPTO', style: 'tableHeader' }, { text: 'MONTO (RD$)', style: 'tableHeaderRight' }],
        [{ text: 'Renta Mensual Base', style: 'tableLabel' }, { text: montoRenta, alignment: 'right' }],
    ];
    
    if (moraRaw > 0) {
        tableBody.push([{ text: 'Moras/Intereses Aplicados', style: 'tableLabelInterest' }, { text: mora, alignment: 'right', style: 'tableLabelInterest' }]);
    }

    if (descuentoRaw > 0) {
         tableBody.push([{ text: 'Descuento Aplicado (Resta)', style: 'tableLabelDiscount' }, { text: `-${descuento}`, alignment: 'right', style: 'tableLabelDiscount' }]);
    }
    
    tableBody.push([{ text: 'TOTAL PAGADO', style: 'totalLabel', fillColor: SECONDARY_COLOR, color: '#fff' }, { text: totalPagar, style: 'totalValue', alignment: 'right', fillColor: SECONDARY_COLOR, color: '#fff' }]);


    const dd = {
        pageSize: 'A6', 
        pageOrientation: 'portrait',
        pageMargins: [15, 15, 15, 15], 
        content: [
            // TÍTULO Y REFERENCIA
            { 
                columns: [
                    { text: 'RECIBO DE PAGO DE RENTA', style: 'header' },
                    { text: `No. ${referencia}`, alignment: 'right', style: 'ref' }
                ],
                margin: [0, 0, 0, 10]
            },
            
            // LÍNEA DE SEPARACIÓN
            { canvas: [{ type: 'line', x1: 0, y1: 0, x2: 380, y2: 0, lineWidth: 2, lineColor: PRIMARY_COLOR }] },
            
            // SECCIÓN PROPIETARIO
            { text: 'DATOS DEL PROPIETARIO', style: 'sectionTitle', margin: [0, 8, 0, 5] },
            { text: [{ text: 'Nombre: ', style: 'label' }, propietario], margin: [0, 0, 0, 3] },
            { text: [{ text: 'Inmueble: ', style: 'label' }, direccionInmueble], margin: [0, 0, 0, 8] },

            // SECCIÓN INQUILINO
            { text: 'DATOS DEL INQUILINO', style: 'sectionTitle', margin: [0, 5, 0, 5] },
            {
                columns: [
                    { text: [{ text: 'Nombre: ', style: 'label' }, inquilino], width: 180 },
                    { text: [{ text: 'Cédula: ', style: 'label' }, cedulaInquilino], width: '*' }
                ],
                margin: [0, 0, 0, 3]
            },
            { text: [{ text: 'Teléfono: ', style: 'label' }, telefonoInquilino], margin: [0, 0, 0, 8] },

            // SECCIÓN DETALLE Y CÁLCULOS
            { text: 'DETALLE DEL PAGO', style: 'sectionTitle', margin: [0, 5, 0, 5] },
            {
                columns: [
                    { text: [{ text: 'Mes Pagado: ', style: 'label' }, mesRenta], width: 130 },
                    { text: [{ text: 'Fecha: ', style: 'label' }, fechaPago || 'N/A'], width: '*' }
                ],
                margin: [0, 0, 0, 10]
            },
            
            // TABLA DE MONTOS
            {
                table: {
                    widths: ['*', 80],
                    body: tableBody
                },
                layout: {
                    hLineWidth: (i, node) => (i === 1 || i === node.table.body.length - 1) ? 1 : 0, 
                    vLineWidth: () => 0, 
                    hLineColor: '#ddd',
                    paddingTop: () => 4, paddingBottom: () => 4,
                },
                margin: [0, 0, 0, 15]
            },
        ],
        // ESTILOS PDF
        styles: {
            header: { fontSize: 12, bold: true, color: PRIMARY_COLOR },
            ref: { fontSize: 9, bold: true, color: SECONDARY_COLOR },
            sectionTitle: { fontSize: 10, bold: true, decoration: 'underline', color: PRIMARY_COLOR, margin: [0, 5, 0, 5] },
            label: { bold: true, color: '#555' },
            tableHeader: { bold: true, fontSize: 8, fillColor: PRIMARY_COLOR, color: '#fff' },
            tableHeaderRight: { bold: true, fontSize: 8, alignment: 'right', fillColor: PRIMARY_COLOR, color: '#fff' },
            tableLabel: { fontSize: 8, color: '#333' },
            tableLabelDiscount: { fontSize: 8, color: '#C0392B' },
            tableLabelInterest: { fontSize: 8, color: '#A0522D' }, 
            totalLabel: { fontSize: 9, bold: true, margin: [0, 3, 0, 3] },
            totalValue: { fontSize: 9, bold: true, margin: [0, 3, 0, 3] },
        },
        defaultStyle: { fontSize: 8 }
    };
    return dd;
}

// --- INICIALIZACIÓN ---

document.addEventListener('DOMContentLoaded', () => {
    // 1. Cargar datos del formulario
    loadFormData();
    
    // 2. Generar el número de referencia automática (siempre la primera acción)
    updateReferenceField();

    // 3. Adjuntar listeners para guardar y calcular
    attachInputListeners();
    
    // 4. Botón de Generar PDF
    document.getElementById('generatePdfBtn').addEventListener('click', () => {
        // 1. Forzar cálculo y guardado de datos antes de generar
        calculateTotals(); 
        
        if (typeof pdfMake === 'undefined') {
            // Esto solo se mostraría si falla la carga de CDN, es una protección
            console.error('Error: La librería pdfmake no está cargada.');
            // Usamos un modal o mensaje personalizado en lugar de alert()
            document.body.insertAdjacentHTML('beforeend', '<div style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);padding:20px;background:red;color:white;border-radius:8px;z-index:1000;">Error: Faltan archivos PDF. Recargue la página.</div>');
            return;
        }

        const dd = buildPdfDefinition();
        
        // 2. Generar el PDF y descargarlo.
        pdfMake.createPdf(dd).download(`recibo_renta_${document.getElementById('referencia').value}.pdf`);
        
        // 3. ¡IMPORTANTE! Incrementar la secuencia SOLO después de la descarga exitosa
        incrementSequence();
    });
});
</script>
</body>
</html>
